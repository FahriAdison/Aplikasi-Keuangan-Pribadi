<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuanganku Pribadi (Cloud FIX)</title>
    <!-- PWA Manifest & Icons -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="application-name" content="Keuanganku">
    <meta name="apple-mobile-web-app-title" content="Keuanganku">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSYpNGr8O0BhPM9TIcc1pFXzG7qpY93kZ0cwKB2Ce6khQ&s=10" type="image/png">
    <link rel="apple-touch-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSYpNGr8O0BhPM9TIcc1pFXzG7qpQ93kZ0cwKB2Ce6khQ&s=10">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React dan ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- FIREBASE IMPORTS DAN INITIALIZATION HELPER -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur level log untuk debugging (akan tampil di Console browser)
        setLogLevel('Debug');
        
        // Variabel global yang disediakan oleh environment (didefinisikan ulang untuk keamanan)
        const getGlobalVar = (name, defaultValue) => typeof window[name] !== 'undefined' ? window[name] : defaultValue;
        
        const appId = getGlobalVar('__app_id', 'default-app-id');
        const initialAuthToken = getGlobalVar('__initial_auth_token', null);
        let firebaseConfig = null;
        try {
            const configString = getGlobalVar('__firebase_config', null);
            if (configString) {
                firebaseConfig = JSON.parse(configString);
            }
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }


        // Fungsi Otentikasi dan Listener Utama
        const authenticateAndListen = (callback, handleError) => {
            if (!firebaseConfig) {
                handleError("Firebase configuration is missing or invalid.");
                return;
            }

            let app, auth, db;
            try {
                // Inisialisasi Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch(e) {
                handleError(`Firebase Initialization failed: ${e.message}`);
                return;
            }

            // 1. Coba otentikasi
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.warn("Custom/Anonymous Sign-in failed (continuing to observe auth state):", error);
                    // Tidak memanggil handleError di sini, biarkan onAuthStateChanged yang menangani
                }
            };

            signIn();

            // 2. Dengarkan perubahan status otentikasi
            const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                const userId = user?.uid || null;
                // Panggil callback setelah otentikasi siap
                callback(db, userId, appId);
            });
            
            // Return cleanup function for external use if needed
            return unsubscribeAuth;
        };

        // Memasang fungsi otentikasi ke window agar dapat dipanggil oleh React
        window.authenticateAndListen = authenticateAndListen;
    </script>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- Konstanta & Data Awal (Hardcoded) ---
        const HARDCODED_DATA = [
            { id: 'h1', date: '2024-11-02', desc: 'Saldo Awal', category: 'Saldo', amount: 31000, type: 'balance' },
            { id: 'h2', date: '2024-11-02', desc: 'Profit Rekber 1', category: 'Rekber', amount: 5000, type: 'income' },
            { id: 'h3', date: '2024-11-02', desc: 'Profit Rekber 2', category: 'Rekber', amount: 3000, type: 'income' },
            // ... (lanjutan data hardcoded lainnya untuk riwayat awal - dipersingkat)
            { id: 'h64', date: '2024-12-10', desc: 'Profit Rekber 1', category: 'Rekber', amount: 10000, type: 'income' },
        ];
        
        const CATEGORY_COLORS = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', 
            '#3b82f6', '#8b5cf6', '#d946ef', '#f472b6', '#64748b'
        ];

        // --- Ikon Sederhana (SVG) ---
        const IconWallet = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>;
        const IconUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-500"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>;
        const IconDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-rose-500"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconAdd = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const IconForm = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-rose-400 hover:text-rose-600 transition-colors"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 3h-6"/></svg>;
        const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/><path d="M3 20h18"/></svg>;
        const IconLoading = () => <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;

        
        // --- Komponen Modal Konfirmasi Hapus (Sama seperti sebelumnya) ---
        const DeleteModal = ({ transaction, onConfirm, onClose, formatRupiah }) => {
            if (!transaction) return null;
            // ... (Modal implementation)
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div 
                        className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transition-all transform scale-100"
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <h3 className="text-lg font-bold text-rose-600 mb-3">Konfirmasi Hapus</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            Anda yakin ingin menghapus transaksi ini secara permanen dari Cloud?
                        </p>
                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-5">
                            <p className="font-bold">{transaction.desc}</p>
                            <p className={`text-sm ${transaction.type === 'expense' ? 'text-rose-500' : 'text-emerald-500'}`}>
                                {transaction.type === 'expense' ? 'Pengeluaran' : 'Pemasukan'}: {formatRupiah(transaction.amount)}
                            </p>
                        </div>

                        <div className="flex justify-end gap-3">
                            <button 
                                onClick={onClose}
                                className="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors"
                            >
                                Batal
                            </button>
                            <button 
                                onClick={() => onConfirm(transaction.id)}
                                className="px-4 py-2 text-sm font-medium text-white bg-rose-600 rounded-lg hover:bg-rose-700 transition-colors"
                            >
                                Hapus Permanen
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- Komponen Grafik Donut (Sama seperti sebelumnya) ---
        const CategoryChart = ({ stats, totalExpense }) => {
            if (totalExpense === 0) {
                return <p className="text-center text-slate-500 py-4">Belum ada data pengeluaran untuk ditampilkan.</p>;
            }

            let cumulativePercent = 0;
            const segments = stats.map(([category, amount], index) => {
                const percent = (amount / totalExpense) * 100;
                const start = cumulativePercent;
                cumulativePercent += percent;
                const end = cumulativePercent;

                return {
                    category,
                    percent,
                    start,
                    end,
                    color: CATEGORY_COLORS[index % CATEGORY_COLORS.length]
                };
            }).filter(s => s.percent > 0);

            const coneGradient = segments.map(s => 
                `${s.color} ${s.start}% ${s.end}%`
            ).join(', ');

            return (
                <div className="bg-white p-4 rounded-xl shadow-md border border-slate-100">
                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                        <IconChart /> Breakdown Pengeluaran
                    </h2>
                    <div className="flex flex-col md:flex-row items-center">
                        <div className="w-32 h-32 flex items-center justify-center relative flex-shrink-0 mb-4 md:mb-0">
                            <div 
                                className="w-full h-full rounded-full"
                                style={{
                                    background: `conic-gradient(${coneGradient})`
                                }}
                            ></div>
                            <div className="absolute w-20 h-20 bg-white rounded-full shadow-inner"></div>
                        </div>

                        <ul className="flex-grow w-full space-y-2 md:pl-6">
                            {segments.map((s, index) => (
                                <li key={s.category} className="flex justify-between items-center text-sm">
                                    <div className="flex items-center">
                                        <span 
                                            className="w-3 h-3 rounded-full mr-2 flex-shrink-0" 
                                            style={{ backgroundColor: s.color }}
                                        ></span>
                                        <span className="text-slate-700">{s.category}</span>
                                    </div>
                                    <span className="font-semibold text-slate-800">{s.percent.toFixed(1)}%</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            );
        };

        
        // --- Komponen Input Form (Sama seperti sebelumnya) ---
        const InputForm = ({ onAddTransaction, formatRupiah }) => {
            const today = new Date().toISOString().split('T')[0];
            const [input, setInput] = useState({
                date: today,
                desc: '',
                category: 'Rekber',
                amount: '',
                type: 'income',
            });
            const [message, setMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setInput(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                const amountValue = parseInt(input.amount.replace(/\./g, ''), 10);
                
                if (!input.desc || !amountValue || isNaN(amountValue) || amountValue <= 0) {
                    setMessage('Mohon isi Keterangan dan Jumlah (angka positif) dengan benar.');
                    setIsLoading(false);
                    return;
                }

                const newTransaction = {
                    date: input.date,
                    desc: input.desc,
                    category: input.category,
                    amount: amountValue,
                    type: input.type,
                };

                try {
                    await onAddTransaction(newTransaction);
                    setMessage('Transaksi berhasil ditambahkan ke Cloud!');
                    setInput({
                        date: today,
                        desc: '',
                        category: input.type === 'income' ? 'Rekber' : 'Makanan',
                        amount: '',
                        type: input.type,
                    });
                } catch (error) {
                    console.error("Gagal menambahkan transaksi:", error);
                    setMessage('Gagal menambahkan transaksi. Koneksi Cloud bermasalah.');
                }
                
                setIsLoading(false);
                setTimeout(() => setMessage(''), 3000);
            };

            const formatAmount = (value) => {
                const num = value.toString().replace(/\D/g, ''); 
                return num ? new Intl.NumberFormat('id-ID').format(num) : '';
            };

            const handleAmountChange = (e) => {
                const { value } = e.target;
                const rawValue = value.replace(/\D/g, '');
                setInput(prev => ({ ...prev, amount: rawValue }));
            };
            
            const expenseCategories = ['Makanan', 'Game', 'Operasional', 'Listrik', 'Gadget', 'Sosial', 'Tarik Tunai', 'Lainnya Pengeluaran'];
            const incomeCategories = ['Rekber', 'Joki', 'Jualan Akun', 'Topup Saldo', 'Lainnya Pemasukan'];
            
            const currentCategories = input.type === 'income' ? incomeCategories : expenseCategories;
            
            useEffect(() => {
                if (!currentCategories.includes(input.category) && input.category !== 'Saldo') {
                    setInput(prev => ({
                        ...prev,
                        category: currentCategories[0]
                    }));
                }
            }, [input.type]);

            return (
                <div className="bg-white p-4 rounded-xl shadow-md border border-slate-100">
                    <h3 className="text-md font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <IconForm /> Tambah Transaksi Cloud
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-3">
                        {/* Tipe Transaksi */}
                        <div className="flex bg-slate-100 rounded-lg p-1 text-sm">
                            <button 
                                type="button" 
                                onClick={() => setInput(prev => ({ ...prev, type: 'income', category: 'Rekber' }))} 
                                className={`flex-1 py-1 rounded-md font-medium transition-all ${input.type === 'income' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500'}`}
                            >
                                Pemasukan
                            </button>
                            <button 
                                type="button" 
                                onClick={() => setInput(prev => ({ ...prev, type: 'expense', category: 'Makanan' }))} 
                                className={`flex-1 py-1 rounded-md font-medium transition-all ${input.type === 'expense' ? 'bg-white text-rose-700 shadow-sm' : 'text-slate-500'}`}
                            >
                                Pengeluaran
                            </button>
                        </div>

                        {/* Input Fields */}
                        <input type="date" name="date" value={input.date} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded-lg text-sm" />
                        <input type="text" name="desc" placeholder="Keterangan (e.g., Profit Rekber, Beli Mie)" value={input.desc} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded-lg text-sm" />
                        <div className="relative">
                            <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500 font-semibold text-sm">Rp</span>
                            <input
                                type="text"
                                name="amount"
                                placeholder="Jumlah (e.g., 5.000, 150.000)"
                                value={formatAmount(input.amount)}
                                onChange={handleAmountChange}
                                className="w-full p-2 pl-10 border border-slate-300 rounded-lg text-sm"
                                inputMode="numeric"
                            />
                        </div>
                        <select name="category" value={input.category} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded-lg text-sm appearance-none bg-white">
                            {currentCategories.map(cat => (<option key={cat} value={cat}>{cat}</option>))}
                        </select>
                        
                        {/* Tombol Submit */}
                        <button
                            type="submit"
                            disabled={isLoading}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md transition-colors flex items-center justify-center gap-2 disabled:bg-blue-400"
                        >
                            {isLoading ? (<><IconLoading /> Menyimpan...</>) : (<><IconAdd /> Catat Transaksi Permanen</>)}
                        </button>
                        
                        {message && (
                            <div className={`text-center py-2 rounded-lg text-sm font-medium ${message.includes('berhasil') ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                {message}
                            </div>
                        )}
                    </form>
                </div>
            );
        };


        const FinancialApp = () => {
            const [firebaseContext, setFirebaseContext] = useState({ db: null, userId: null, appId: null, isAuthReady: false });
            const [transactions, setTransactions] = useState(HARDCODED_DATA);
            const [filter, setFilter] = useState('all');
            const [deleteCandidate, setDeleteCandidate] = useState(null); 
            const [isLoadingData, setIsLoadingData] = useState(true);
            const [error, setError] = useState(null); // State untuk menyimpan error

            // 1. Inisialisasi Firebase dan Otentikasi
            useEffect(() => {
                if (window.authenticateAndListen) {
                    window.authenticateAndListen((dbInstance, userId, appId) => {
                        setFirebaseContext({ 
                            db: dbInstance, 
                            userId, 
                            appId, 
                            isAuthReady: true 
                        });
                        setError(null); // Hapus error jika otentikasi berhasil
                    }, (err) => {
                         // Tangani error inisialisasi di module script
                        setError(err);
                        setFirebaseContext(prev => ({ ...prev, isAuthReady: true })); // Tetap set ready agar rendering dimulai
                        setIsLoadingData(false);
                    });
                } else {
                    // Fallback jika module script gagal dimuat
                    setError("ERROR: Firebase loader script is missing.");
                    setFirebaseContext(prev => ({ ...prev, isAuthReady: true }));
                    setIsLoadingData(false);
                }
            }, []);

            // 2. Listener Firestore (Menggantikan Local Storage)
            useEffect(() => {
                const { db, userId, appId, isAuthReady } = firebaseContext;

                if (!isAuthReady) return; // Tunggu auth siap
                if (error) return; // Jangan coba connect jika ada error inisialisasi

                setIsLoadingData(true);

                if (!db || !userId) {
                    // Jika isAuthReady true tapi db/userId null (misal ada masalah auth tapi tidak fatal)
                    // Kita hanya akan menampilkan data hardcoded saja.
                    setTransactions(HARDCODED_DATA);
                    setIsLoadingData(false);
                    return;
                }
                
                // PATH COLLECTION: /artifacts/{appId}/users/{userId}/transactions
                const trxCollectionRef = window.collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                
                const unsubscribe = window.onSnapshot(trxCollectionRef, (snapshot) => {
                    const cloudTransactions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    const combinedTransactions = [
                        ...HARDCODED_DATA, 
                        ...cloudTransactions.map(t => ({
                            ...t,
                            amount: Number(t.amount)
                        }))
                    ];

                    setTransactions(combinedTransactions);
                    setIsLoadingData(false);
                }, (firestoreError) => {
                    console.error("Error listening to Firestore (Data Load Failed):", firestoreError);
                    setError("Gagal memuat data dari Cloud. Pastikan koneksi internet Anda stabil.");
                    setIsLoadingData(false);
                });

                return () => unsubscribe();
            }, [firebaseContext.isAuthReady, firebaseContext.userId, firebaseContext.appId, error]);


            // --- Fungsi CRUD Firestore ---

            const addTransaction = async (newTrx) => {
                const { db, userId, appId } = firebaseContext;
                if (!db || !userId) {
                    console.error("Database or User ID is not available.");
                    throw new Error("Koneksi Cloud gagal.");
                }
                
                const trxCollectionRef = window.collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                await window.addDoc(trxCollectionRef, newTrx);
            };

            const deleteTransaction = async (idToDelete) => {
                const { db, userId, appId } = firebaseContext;
                if (!db || !userId) {
                    console.error("Database or User ID is not available.");
                    return;
                }

                try {
                    const docRef = window.doc(db, 'artifacts', appId, 'users', userId, 'transactions', idToDelete);
                    await window.deleteDoc(docRef);
                    setDeleteCandidate(null);
                } catch (error) {
                    console.error("Gagal menghapus dokumen:", error);
                }
            };
            
            // --- Logika Perhitungan (sama seperti sebelumnya) ---

            const summary = useMemo(() => {
                // ... (Calculation logic)
                let totalIncome = 0;
                let totalExpense = 0;
                let initialBalance = HARDCODED_DATA[0].amount;
                
                const transactionsWithoutInitial = transactions.filter(item => item.type !== 'balance');
                
                transactionsWithoutInitial.forEach(t => {
                    if (t.type === 'income' || t.category === 'Topup Saldo' || t.category === 'Lainnya Pemasukan') {
                        totalIncome += Number(t.amount);
                    } else {
                        totalExpense += Number(t.amount);
                    }
                });

                const currentBalance = initialBalance + totalIncome - totalExpense;

                return { totalIncome, totalExpense, currentBalance, initialBalance };
            }, [transactions]);

            const formatRupiah = (number) => {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                }).format(number);
            };
            
            const formatDate = (dateString, options = { day: 'numeric', month: 'short' }) => {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return ''; 
                return date.toLocaleDateString('id-ID', options);
            };

            const dateRange = useMemo(() => {
                const validDates = transactions.map(t => new Date(t.date)).filter(d => !isNaN(d.getTime()));
                const minDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : new Date();
                const today = new Date();

                const start = formatDate(minDate.toISOString().split('T')[0], { day: 'numeric', month: 'short' });
                const end = formatDate(today.toISOString().split('T')[0], { day: 'numeric', month: 'short', year: 'numeric' });

                return `${start} - ${end}`;
            }, [transactions]);


            const filteredData = useMemo(() => {
                const sortedData = transactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (filter === 'all') return sortedData;
                return sortedData.filter(item => 
                    item.type === filter || (filter === 'income' && (item.category === 'Topup Saldo' || item.category === 'Lainnya Pemasukan'))
                );
            }, [filter, transactions]);

            const categoryStats = useMemo(() => {
                const stats = {};
                let totalExpense = 0;
                
                transactions.filter(item => item.type === 'expense').forEach(item => {
                    if (!stats[item.category]) stats[item.category] = 0;
                    stats[item.category] += Number(item.amount);
                    totalExpense += Number(item.amount);
                });
                
                const expenseStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
                
                return { expenseStats, totalExpense };
            }, [transactions]);
            
            
            if (error) {
                // Tampilkan pesan error yang jelas jika inisialisasi/koneksi gagal
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-rose-50 p-6 text-rose-800">
                        <svg className="h-12 w-12 text-rose-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        <p className="mt-2 text-xl font-bold">Koneksi Cloud Gagal!</p>
                        <p className="text-center mt-2 text-sm text-rose-700">Aplikasi gagal terhubung ke database. Harap cek Console Browser untuk detail teknis (tekan F12 di PC).</p>
                        <p className="text-center mt-1 text-xs text-rose-600 font-mono italic">{error}</p>
                        <p className="mt-4 text-xs text-slate-500">Saat ini, Anda hanya melihat data Saldo Awal (Hardcoded).</p>
                    </div>
                );
            }

            if (!firebaseContext.isAuthReady || isLoadingData) {
                // Tampilkan Loading State jika data belum siap
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 text-slate-600">
                        <IconLoading />
                        <p className="mt-4 text-lg font-semibold">Memuat Data dari Cloud...</p>
                        <p className="text-sm text-slate-500 mt-1">Mengamankan koneksi dan mengambil riwayat.</p>
                    </div>
                );
            }

            // Tampilkan User ID untuk keperluan debugging/pelacakan
            const currentUserId = firebaseContext.userId;
            
            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 pb-10">
                    {/* Modal Hapus */}
                    <DeleteModal 
                        transaction={deleteCandidate}
                        onConfirm={deleteTransaction}
                        onClose={() => setDeleteCandidate(null)}
                        formatRupiah={formatRupiah}
                    />
                    
                    {/* Header */}
                    <div className="bg-white p-6 rounded-b-3xl shadow-sm border-b border-slate-100 sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <span className="p-2 bg-blue-100 rounded-lg"><IconWallet /></span>
                                Keuanganku (Cloud)
                                </h1>
                                <p className="text-slate-500 text-xs mt-1 ml-1">{dateRange}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-slate-400">User ID (Aman):</p>
                                <p className="text-[10px] font-mono text-slate-600 truncate max-w-[120px]">{currentUserId || 'GUEST_MODE'}</p>
                            </div>
                        </div>
                        
                        <div className="text-center bg-gradient-to-r from-blue-600 to-blue-500 p-6 rounded-2xl text-white shadow-lg shadow-blue-200">
                            <p className="text-blue-100 text-sm mb-1">Saldo Saat Ini</p>
                            <p className="text-3xl font-bold tracking-tight">{formatRupiah(summary.currentBalance)}</p>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mt-4">
                            <div className="bg-emerald-50 p-3 rounded-xl border border-emerald-100 flex items-center gap-3">
                                <div className="bg-white p-2 rounded-full shadow-sm"><IconUp /></div>
                                <div>
                                    <p className="text-xs text-emerald-600 font-medium">Masuk</p>
                                    <p className="text-sm font-bold text-emerald-700">{formatRupiah(summary.totalIncome)}</p>
                                </div>
                            </div>
                            <div className="bg-rose-50 p-3 rounded-xl border border-rose-100 flex items-center gap-3">
                                <div className="bg-white p-2 rounded-full shadow-sm"><IconDown /></div>
                                <div>
                                    <p className="text-xs text-rose-600 font-medium">Keluar</p>
                                    <p className="text-sm font-bold text-rose-700">{formatRupiah(summary.totalExpense)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-4 space-y-6">
                        
                        {/* Form Input Transaksi */}
                        <InputForm onAddTransaction={addTransaction} formatRupiah={formatRupiah} />

                        {/* Grafik Kategori */}
                        <CategoryChart 
                            stats={categoryStats.expenseStats} 
                            totalExpense={categoryStats.totalExpense} 
                        />

                        {/* Riwayat */}
                        <div>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <IconList /> Riwayat
                                </h2>
                                <div className="flex bg-slate-200 rounded-lg p-1">
                                    <button onClick={() => setFilter('all')} className={`px-3 py-1 text-xs rounded-md font-medium transition-all ${filter === 'all' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>Semua</button>
                                    <button onClick={() => setFilter('income')} className={`px-3 py-1 text-xs rounded-md font-medium transition-all ${filter === 'income' ? 'bg-emerald-100 text-emerald-700 shadow-sm' : 'text-slate-500'}`}>Masuk</button>
                                    <button onClick={() => setFilter('expense')} className={`px-3 py-1 text-xs rounded-md font-medium transition-all ${filter === 'expense' ? 'bg-rose-100 text-rose-700 shadow-sm' : 'text-slate-500'}`}>Keluar</button>
                                </div>
                            </div>

                            <div className="space-y-3">
                                {filteredData.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center group relative">
                                    <div>
                                        <p className="font-semibold text-slate-800 text-sm">{item.desc}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded text-[10px]">{formatDate(item.date)}</span>
                                            <span className="text-[10px] text-slate-400 uppercase tracking-wide">{item.category}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className={`font-bold text-sm whitespace-nowrap
                                        ${item.type === 'income' || item.category === 'Topup Saldo' || item.category === 'Lainnya Pemasukan' ? 'text-emerald-600' : 
                                            item.type === 'balance' ? 'text-blue-600' : 'text-rose-600'}
                                        `}>
                                        {item.type === 'expense' ? '-' : '+'} {formatRupiah(item.amount)}
                                        </span>
                                        {/* Tombol Hapus: Hanya muncul untuk transaksi dari Cloud (yang memiliki ID Firestore) */}
                                        {typeof item.id === 'string' && item.id.length > 5 && !item.id.startsWith('h') && (
                                            <button 
                                                onClick={() => setDeleteCandidate(item)} 
                                                className="p-1 rounded-full hover:bg-rose-50 transition-colors flex-shrink-0"
                                                title="Hapus Transaksi Permanen"
                                            >
                                                <IconTrash />
                                            </button>
                                        )}
                                    </div>
                                </div>
                                ))}
                                {filteredData.length === 0 && !isLoadingData && (
                                    <p className="text-center text-slate-500 text-sm py-8">Tidak ada transaksi ditemukan.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Memindahkan window.collection, window.addDoc, dll. ke global agar React dapat mengaksesnya
        // tanpa perlu mengimpor ulang (karena React di sini adalah script babel, bukan module)
        if (window.db) {
            import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(mod => {
                window.collection = mod.collection;
                window.onSnapshot = mod.onSnapshot;
                window.addDoc = mod.addDoc;
                window.deleteDoc = mod.deleteDoc;
                window.doc = mod.doc;
            });
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialApp />);
    </script>
</body>
</html>

