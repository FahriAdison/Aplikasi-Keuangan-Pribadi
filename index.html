<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Keuangan Pribadi</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icon dari Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Konfigurasi Font -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.93);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        }
        .income-color { color: #10B981; }
        .expense-color { color: #EF4444; }
        .balance-positive { color: #3B82F6; }
        .balance-negative { color: #EF4444; }
        .page-transition {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            margin-right: 8px;
        }
        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Loading state button */
        .loading-btn {
            position: relative;
            pointer-events: none;
        }
        .loading-btn:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
<div id="app" class="min-h-screen p-4 md:p-8">
    <!-- ==================== HALAMAN LOGIN/REGISTER ==================== -->
    <div id="auth-page" class="page-transition">
        <div class="max-w-md mx-auto mt-8 md:mt-16">
            <!-- Header Aplikasi -->
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full mb-4 shadow-lg">
                    <i class="fas fa-wallet text-white text-4xl"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Catatan Keuangan Pribadi</h1>
                <p class="text-gray-600 text-lg">Kelola keuangan Anda dengan aman</p>
            </div>
            <!-- Kartu Login/Register -->
            <div class="glass-card rounded-2xl shadow-2xl overflow-hidden">
                <!-- Tab Navigation -->
                <div class="flex border-b">
                    <button id="tab-login" class="flex-1 py-4 font-bold text-lg border-b-2 border-indigo-600 text-indigo-600 bg-indigo-50 transition-all duration-300">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                    <button id="tab-register" class="flex-1 py-4 font-bold text-lg text-gray-600 hover:text-gray-800 hover:bg-gray-50 transition-all duration-300">
                        <i class="fas fa-user-plus mr-2"></i>Register
                    </button>
                </div>
                <!-- Konten Form -->
                <div class="p-6 md:p-8">
                    <!-- Form Login -->
                    <form id="login-form" class="space-y-5">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email
                            </label>
                            <input type="email" id="login-email" placeholder="anda@email.com" 
                                   class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                            <p id="login-email-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2"></i>Password
                            </label>
                            <div class="relative">
                                <input type="password" id="login-password" placeholder="Minimal 6 karakter" 
                                       class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition pr-10" required>
                                <button type="button" id="toggle-login-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p id="login-password-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <!-- Remember Me & Forgot Password -->
                        <div class="flex justify-between items-center">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="remember-me" class="custom-checkbox">
                                <span class="text-sm text-gray-700 ml-2">Ingat Saya</span>
                            </label>
                            <button type="button" id="forgot-password-btn" class="text-sm text-blue-600 hover:text-blue-800 transition">
                                <i class="fas fa-key mr-1"></i>Lupa Password?
                            </button>
                        </div>
                        <button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1 shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk ke Aplikasi
                        </button>
                    </form>
                    <!-- Form Register (Awalnya Tersembunyi) -->
                    <form id="register-form" class="space-y-5 hidden">
                        <div>
                            <label for="register-name" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>Nama Lengkap
                            </label>
                            <input type="text" id="register-name" placeholder="Nama Anda" 
                                   class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                            <p id="register-name-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email
                            </label>
                            <input type="email" id="register-email" placeholder="anda@email.com" 
                                   class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                            <p id="register-email-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2"></i>Password
                            </label>
                            <div class="relative">
                                <input type="password" id="register-password" placeholder="Minimal 6 karakter" 
                                       class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition pr-10" required>
                                <button type="button" id="toggle-register-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="flex items-center mb-1">
                                    <div id="password-strength-bar" class="h-2 flex-grow bg-gray-200 rounded-full overflow-hidden">
                                        <div id="password-strength-fill" class="h-full w-0 transition-all duration-300"></div>
                                    </div>
                                    <span id="password-strength-text" class="ml-2 text-xs font-medium text-gray-500">Lemah</span>
                                </div>
                                <p class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>Gunakan kombinasi huruf, angka, dan simbol
                                </p>
                            </div>
                        </div>
                        <div>
                            <label for="register-confirm" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2"></i>Konfirmasi Password
                            </label>
                            <input type="password" id="register-confirm" placeholder="Ketik ulang password" 
                                   class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                            <p id="register-confirm-error" class="text-red-500 text-xs mt-1 hidden"></p>
                        </div>
                        <button type="submit" id="register-submit-btn" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 transform hover:-translate-y-1 shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>Buat Akun Baru
                        </button>
                    </form>
                    <!-- Pesan Error/Success -->
                    <div id="auth-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>
                    <!-- Pembatas -->
                    <div class="my-6 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="px-3 text-gray-500">atau</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <!-- Tombol Guest Mode -->
                    <div class="text-center">
                        <button id="guest-login" class="w-full py-3 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 font-bold rounded-xl hover:from-gray-300 hover:to-gray-400 transition-all duration-300 shadow-md">
                            <i class="fas fa-user-secret mr-2"></i>Lanjut sebagai Tamu
                        </button>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Data tamu hanya tersimpan di browser ini
                        </p>
                    </div>
                </div>
            </div>
            <!-- Footer Login -->
            <div class="text-center mt-6 text-gray-500 text-sm">
                <p>Data Anda disimpan aman di Firebase Cloud</p>
                <p class="mt-1">© 2025 Catatan Keuangan Pribadi</p>
            </div>
        </div>
    </div>
    <!-- ==================== MODAL LUPA PASSWORD ==================== -->
    <div id="forgot-password-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-key mr-2 text-indigo-600"></i>Reset Password
                </h2>
                <button id="close-forgot-modal" class="text-gray-500 hover:text-gray-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-6">Masukkan email Anda. Kami akan mengirimkan link untuk reset password.</p>
            <div class="space-y-4">
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email Terdaftar
                    </label>
                    <input type="email" id="reset-email" placeholder="email@anda.com" 
                           class="w-full p-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                    <p id="reset-email-error" class="text-red-500 text-xs mt-1 hidden"></p>
                </div>
                <div class="flex space-x-3">
                    <button id="cancel-reset" class="flex-1 py-3 bg-gray-200 text-gray-800 font-medium rounded-xl hover:bg-gray-300 transition">
                        Batal
                    </button>
                    <button id="send-reset-email" class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium rounded-xl hover:from-indigo-700 hover:to-purple-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim
                    </button>
                </div>
            </div>
            <div id="reset-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </div>
    </div>
    <!-- ==================== HALAMAN UTAMA APLIKASI ==================== -->
    <div id="main-app" class="hidden page-transition">
        <div class="max-w-6xl mx-auto">
            <!-- Header dengan User Info -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">
                        <i class="fas fa-wallet text-indigo-600 mr-3"></i>Catatan Keuangan Pribadi
                    </h1>
                    <div class="flex items-center mt-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                        <p class="text-gray-600">
                            Halo, <span id="user-name" class="font-semibold text-gray-800">Pengguna</span>
                            <span id="guest-badge" class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full hidden">
                                <i class="fas fa-user-secret mr-1"></i>Mode Tamu
                            </span>
                        </p>
                    </div>
                </div>
                <div class="flex flex-col md:items-end">
                    <p id="user-email" class="text-sm text-gray-600 mb-2"></p>
                    <div class="flex space-x-2">
                        <button id="backup-btn" class="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
                            <i class="fas fa-download mr-2"></i>Backup
                        </button>
                        <button id="logout-btn" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
            <!-- Dashboard Ringkasan -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Kartu Saldo -->
                <div class="glass-card p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-money-bill-wave text-white text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Saldo Saat Ini</p>
                            <div id="current-balance" class="text-2xl md:text-3xl font-bold balance-positive">Rp 0</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">Update real-time</p>
                </div>
                <!-- Kartu Pemasukan -->
                <div class="glass-card p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-400 to-green-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-arrow-down text-white text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Pemasukan</p>
                            <div id="total-income" class="text-2xl md:text-3xl font-bold income-color">Rp 0</div>
                        </div>
                    </div>
                    <p id="income-count" class="text-xs text-gray-400">0 transaksi</p>
                </div>
                <!-- Kartu Pengeluaran -->
                <div class="glass-card p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-red-400 to-red-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-arrow-up text-white text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Pengeluaran</p>
                            <div id="total-expense" class="text-2xl md:text-3xl font-bold expense-color">Rp 0</div>
                        </div>
                    </div>
                    <p id="expense-count" class="text-xs text-gray-400">0 transaksi</p>
                </div>
                <!-- Kartu Statistik -->
                <div class="glass-card p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-chart-line text-white text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Transaksi</p>
                            <div id="total-transactions" class="text-2xl md:text-3xl font-bold text-gray-800">0</div>
                        </div>
                    </div>
                    <p id="last-update" class="text-xs text-gray-400">Belum ada data</p>
                </div>
            </div>
            <!-- Filter dan Kontrol -->
            <div class="glass-card p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold mb-4 md:mb-0">
                        <i class="fas fa-filter text-indigo-600 mr-2"></i>Filter Transaksi
                    </h2>
                    <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 w-full md:w-auto">
                        <!-- Filter Bulanan -->
                        <div class="flex-1">
                            <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calendar-alt mr-1"></i>Bulan & Tahun
                            </label>
                            <input type="month" id="month-filter" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        </div>
                        <!-- Filter Tipe Transaksi -->
                        <div class="flex-1">
                            <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-list mr-1"></i>Jenis Transaksi
                            </label>
                            <select id="type-filter" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                                <option value="all">Semua Transaksi</option>
                                <option value="pemasukan">Pemasukan</option>
                                <option value="pengeluaran">Pengeluaran</option>
                            </select>
                        </div>
                        <!-- Filter Kategori -->
                        <div class="flex-1">
                            <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-tag mr-1"></i>Kategori
                            </label>
                            <select id="category-filter" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                                <option value="all">Semua Kategori</option>
                                <option value="gaji">Gaji</option>
                                <option value="investasi">Investasi</option>
                                <option value="hadiah">Hadiah</option>
                                <option value="makanan">Makanan & Minuman</option>
                                <option value="transportasi">Transportasi</option>
                                <option value="belanja">Belanja</option>
                                <option value="hiburan">Hiburan</option>
                                <option value="kesehatan">Kesehatan</option>
                                <option value="pendidikan">Pendidikan</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                        <!-- Tombol Reset Filter -->
                        <div class="flex items-end">
                            <button id="reset-filter" class="w-full md:w-auto px-4 py-3 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 font-medium rounded-xl hover:from-gray-300 hover:to-gray-400 transition shadow-md">
                                <i class="fas fa-redo mr-2"></i>Reset Filter
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Statistik Bulanan -->
                <div id="monthly-stats" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Transaksi</p>
                            <p id="month-transaction-count" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Rata-rata Harian</p>
                            <p id="month-daily-avg" class="text-2xl font-bold text-gray-800">Rp 0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Transaksi Terbesar</p>
                            <p id="month-largest" class="text-2xl font-bold text-gray-800">Rp 0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Saldo Bulanan</p>
                            <p id="month-balance" class="text-2xl font-bold balance-positive">Rp 0</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Form Transaksi Baru -->
            <div class="glass-card p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-plus-circle text-green-600 mr-2"></i>Tambah Transaksi Baru
                </h2>
                <form id="transaction-form" class="space-y-6">
                    <!-- Tipe Transaksi -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button type="button" id="type-pemasukan" class="flex items-center justify-center p-4 rounded-xl font-bold bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg transition-all duration-300 hover:from-green-600 hover:to-green-700 transform hover:-translate-y-1">
                            <i class="fas fa-arrow-down mr-3"></i>Pemasukan (+)
                        </button>
                        <button type="button" id="type-pengeluaran" class="flex items-center justify-center p-4 rounded-xl font-bold bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 shadow-lg transition-all duration-300 hover:from-gray-300 hover:to-gray-400 transform hover:-translate-y-1">
                            <i class="fas fa-arrow-up mr-3"></i>Pengeluaran (-)
                        </button>
                        <input type="hidden" id="transaction-type" value="pemasukan">
                    </div>
                    <!-- Jumlah dan Kategori -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-bill-wave mr-1"></i>Jumlah (Rp)
                            </label>
                            <input type="number" id="amount" placeholder="Contoh: 50000" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-tag mr-1"></i>Kategori
                            </label>
                            <select id="category" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                                <option value="lainnya">Lainnya</option>
                                <option value="gaji">Gaji</option>
                                <option value="investasi">Investasi</option>
                                <option value="hadiah">Hadiah</option>
                                <option value="makanan">Makanan & Minuman</option>
                                <option value="transportasi">Transportasi</option>
                                <option value="belanja">Belanja</option>
                                <option value="hiburan">Hiburan</option>
                                <option value="kesehatan">Kesehatan</option>
                                <option value="pendidikan">Pendidikan</option>
                            </select>
                        </div>
                    </div>
                    <!-- Keterangan dan Tanggal -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-sticky-note mr-1"></i>Keterangan
                            </label>
                            <input type="text" id="description" placeholder="Contoh: Gaji bulanan, Beli kopi" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-day mr-1"></i>Tanggal
                            </label>
                            <input type="date" id="date" class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" required>
                        </div>
                    </div>
                    <!-- Tombol Submit -->
                    <button type="submit" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl shadow-lg hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1">
                        <i class="fas fa-save mr-3"></i>Catat Transaksi
                    </button>
                </form>
            </div>
            <!-- Daftar Transaksi -->
            <div class="glass-card p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-history text-indigo-600 mr-2"></i>Riwayat Transaksi
                            <span id="filter-indicator" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full hidden"></span>
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">Transaksi akan otomatis tersinkronisasi</p>
                    </div>
                    <div class="mt-2 md:mt-0">
                        <p class="text-sm text-gray-600">
                            Menampilkan <span id="transaction-count" class="font-bold">0</span> transaksi
                            <span id="filtered-count" class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded ml-2 hidden"></span>
                        </p>
                    </div>
                </div>
                <!-- Loading State -->
                <div id="loading-transactions" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-500">Memuat data transaksi...</p>
                </div>
                <!-- Daftar Transaksi -->
                <div id="transactions-list" class="space-y-4">
                    <!-- Transaksi akan dimuat di sini -->
                </div>
                <!-- Pesan tidak ada data -->
                <div id="no-data-message" class="text-center py-8 hidden">
                    <div class="inline-block p-4 bg-gray-100 rounded-full mb-4">
                        <i class="fas fa-inbox text-gray-400 text-3xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg font-medium">Belum ada transaksi</p>
                    <p class="text-gray-400 text-sm mt-2">Mulailah dengan menambahkan transaksi pertama Anda!</p>
                </div>
                <!-- Pagination -->
                <div id="pagination" class="mt-6 pt-6 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center">
                        <button id="prev-page" class="px-4 py-2 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-700 rounded-lg hover:from-gray-300 hover:to-gray-400 transition flex items-center">
                            <i class="fas fa-chevron-left mr-2"></i>Sebelumnya
                        </button>
                        <span id="page-info" class="text-sm text-gray-600">Halaman 1 dari 1</span>
                        <button id="next-page" class="px-4 py-2 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-700 rounded-lg hover:from-gray-300 hover:to-gray-400 transition flex items-center">
                            Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="text-center text-gray-500 text-sm mt-8 pt-8 border-t border-gray-200">
                <p>© 2025 Catatan Keuangan Pribadi. Data tersimpan aman di Firebase Cloud.</p>
                <p class="mt-1">
                    <i class="fas fa-database mr-1"></i>Total transaksi: <span id="total-transaction-count">0</span> | 
                    <i class="fas fa-clock ml-3 mr-1"></i>Diperbarui: <span id="last-update-time">-</span>
                </p>
            </div>
        </div>
    </div>
</div>
<!-- Firebase SDK Imports (Module) -->
<script type="module">
    // Mengimpor modul Firebase yang diperlukan dari CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInAnonymously,
        updateProfile,
        sendPasswordResetEmail,
        setPersistence,
        browserLocalPersistence,
        browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        addDoc, 
        onSnapshot, 
        query, 
        deleteDoc,
        setDoc,
        getDoc,
        getDocs,
        where,
        orderBy,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "%%FIREBASE_API_KEY%%",
        authDomain: "%%FIREBASE_AUTH_DOMAIN%%",
        projectId: "%%FIREBASE_PROJECT_ID%%",
        storageBucket: "%%FIREBASE_STORAGE_BUCKET%%",
        messagingSenderId: "%%FIREBASE_MESSAGING_SENDER_ID%%",
        appId: "%%FIREBASE_APP_ID%%",
        measurementId: "%%FIREBASE_MEASUREMENT_ID%%"
    };
    // ==================== VARIABEL GLOBAL ====================
    let app, db, auth, userId = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentUser = null;
    // Filter state
    let currentFilter = {
        month: null,
        type: 'all',
        category: 'all'
    };
    // Pagination state
    let currentPage = 1;
    const itemsPerPage = 10;
    // Email validation cache
    let emailCache = new Set();
    let usernameCache = new Set();
    // ==================== ELEMEN UI ====================
    // Halaman
    const authPage = document.getElementById('auth-page');
    const mainApp = document.getElementById('main-app');
    // Elemen Auth
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const toggleLoginPassword = document.getElementById('toggle-login-password');
    const registerName = document.getElementById('register-name');
    const registerEmail = document.getElementById('register-email');
    const registerPassword = document.getElementById('register-password');
    const registerConfirm = document.getElementById('register-confirm');
    const toggleRegisterPassword = document.getElementById('toggle-register-password');
    const guestLoginBtn = document.getElementById('guest-login');
    const authMessage = document.getElementById('auth-message');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const registerSubmitBtn = document.getElementById('register-submit-btn');
    // Password strength elements
    const passwordStrengthBar = document.getElementById('password-strength-bar');
    const passwordStrengthFill = document.getElementById('password-strength-fill');
    const passwordStrengthText = document.getElementById('password-strength-text');
    // Modal elements
    const forgotPasswordModal = document.getElementById('forgot-password-modal');
    const closeForgotModal = document.getElementById('close-forgot-modal');
    const cancelReset = document.getElementById('cancel-reset');
    const sendResetEmail = document.getElementById('send-reset-email');
    const resetEmail = document.getElementById('reset-email');
    const resetEmailError = document.getElementById('reset-email-error');
    const resetMessage = document.getElementById('reset-message');
    // Elemen Main App
    const logoutBtn = document.getElementById('logout-btn');
    const backupBtn = document.getElementById('backup-btn');
    const userNameEl = document.getElementById('user-name');
    const userEmailEl = document.getElementById('user-email');
    const guestBadge = document.getElementById('guest-badge');
    const currentBalanceEl = document.getElementById('current-balance');
    const totalIncomeEl = document.getElementById('total-income');
    const totalExpenseEl = document.getElementById('total-expense');
    const incomeCountEl = document.getElementById('income-count');
    const expenseCountEl = document.getElementById('expense-count');
    const totalTransactionsEl = document.getElementById('total-transactions');
    const lastUpdateEl = document.getElementById('last-update-time');
    // Elemen Filter
    const monthFilterEl = document.getElementById('month-filter');
    const typeFilterEl = document.getElementById('type-filter');
    const categoryFilterEl = document.getElementById('category-filter');
    const resetFilterBtn = document.getElementById('reset-filter');
    const filterIndicatorEl = document.getElementById('filter-indicator');
    const transactionCountEl = document.getElementById('transaction-count');
    const totalTransactionCountEl = document.getElementById('total-transaction-count');
    const filteredCountEl = document.getElementById('filtered-count');
    const monthlyStatsEl = document.getElementById('monthly-stats');
    const monthTransactionCountEl = document.getElementById('month-transaction-count');
    const monthDailyAvgEl = document.getElementById('month-daily-avg');
    const monthLargestEl = document.getElementById('month-largest');
    const monthBalanceEl = document.getElementById('month-balance');
    // Elemen Form Transaksi
    const transactionForm = document.getElementById('transaction-form');
    const typePemasukanBtn = document.getElementById('type-pemasukan');
    const typePengeluaranBtn = document.getElementById('type-pengeluaran');
    const transactionTypeInput = document.getElementById('transaction-type');
    const amountInput = document.getElementById('amount');
    const categoryInput = document.getElementById('category');
    const descriptionInput = document.getElementById('description');
    const dateInput = document.getElementById('date');
    // Elemen Transaksi
    const transactionsListEl = document.getElementById('transactions-list');
    const loadingTransactionsEl = document.getElementById('loading-transactions');
    const noDataMessageEl = document.getElementById('no-data-message');
    const paginationEl = document.getElementById('pagination');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfoEl = document.getElementById('page-info');
    // ==================== INISIALISASI ====================
    // Set tanggal hari ini sebagai default
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    dateInput.value = formattedDate;
    monthFilterEl.value = currentMonth;
    // Cek localStorage untuk "Remember Me"
    const savedEmail = localStorage.getItem('rememberedEmail');
    const savedRememberMe = localStorage.getItem('rememberMe') === 'true';
    if (savedEmail && savedRememberMe) {
        loginEmail.value = savedEmail;
        rememberMeCheckbox.checked = true;
    }
    // ==================== HELPER FUNCTIONS ====================
    const formatRupiah = (number) => {
        const absoluteNumber = Math.abs(number);
        const formatted = absoluteNumber.toLocaleString('id-ID'); 
        return 'Rp ' + formatted;
    };
    const getMonthName = (dateString) => {
        const date = new Date(dateString + '-01');
        return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
    };
    const showNotification = (message, type = 'info', duration = 5000) => {
        // Hapus notifikasi sebelumnya
        const existingNotif = document.querySelector('.notification-toast');
        if (existingNotif) existingNotif.remove();
        // Buat notifikasi baru
        const notification = document.createElement('div');
        notification.className = `notification-toast fixed top-4 right-4 px-6 py-3 rounded-xl shadow-xl z-50 transform transition-all duration-300 ${
            type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 
            type === 'error' ? 'bg-gradient-to-r from-red-500 to-pink-600' : 
            'bg-gradient-to-r from-blue-500 to-indigo-600'
        } text-white`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-info-circle'
                } mr-3 text-lg"></i>
                <span class="font-medium">${message}</span>
                <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(notification);
        // Auto remove setelah duration
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
        return notification;
    };
    const showAuthMessage = (message, type = 'error') => {
        authMessage.textContent = message;
        authMessage.className = 'mt-4 p-3 rounded-lg text-center';
        if (type === 'success') {
            authMessage.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
        } else if (type === 'warning') {
            authMessage.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
        } else {
            authMessage.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
        }
        authMessage.classList.remove('hidden');
        // Auto hide setelah 5 detik
        setTimeout(() => {
            authMessage.classList.add('hidden');
        }, 5000);
    };
    const validateEmail = (email) => {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    };
    const validatePassword = (password) => {
        // Minimal 6 karakter
        if (password.length < 6) {
            return { valid: false, message: 'Password minimal 6 karakter' };
        }
        // Cek kekuatan password
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        return { 
            valid: true, 
            strength: strength,
            message: strength >= 3 ? 'Kuat' : strength >= 2 ? 'Sedang' : 'Lemah'
        };
    };
    const updatePasswordStrength = (password) => {
        const validation = validatePassword(password);
        if (!password) {
            passwordStrengthFill.style.width = '0%';
            passwordStrengthText.textContent = 'Lemah';
            passwordStrengthFill.className = 'h-full w-0 transition-all duration-300';
            return;
        }
        if (!validation.valid) {
            passwordStrengthFill.style.width = '20%';
            passwordStrengthFill.className = 'h-full w-1/5 bg-red-500 transition-all duration-300';
            passwordStrengthText.textContent = 'Terlalu pendek';
            passwordStrengthText.className = 'ml-2 text-xs font-medium text-red-500';
            return;
        }
        let width, color, textColor;
        switch(validation.strength) {
            case 1:
                width = '25%';
                color = 'bg-red-500';
                textColor = 'text-red-500';
                break;
            case 2:
                width = '50%';
                color = 'bg-yellow-500';
                textColor = 'text-yellow-500';
                break;
            case 3:
                width = '75%';
                color = 'bg-blue-500';
                textColor = 'text-blue-500';
                break;
            case 4:
                width = '100%';
                color = 'bg-green-500';
                textColor = 'text-green-500';
                break;
            default:
                width = '20%';
                color = 'bg-red-500';
                textColor = 'text-red-500';
        }
        passwordStrengthFill.style.width = width;
        passwordStrengthFill.className = `h-full ${color} transition-all duration-300`;
        passwordStrengthText.textContent = validation.message;
        passwordStrengthText.className = `ml-2 text-xs font-medium ${textColor}`;
    };
    const showFieldError = (fieldId, message) => {
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            // Tambahkan animasi shake
            const inputField = document.getElementById(fieldId);
            if (inputField) {
                inputField.classList.add('shake');
                setTimeout(() => inputField.classList.remove('shake'), 500);
            }
        }
    };
    const hideFieldError = (fieldId) => {
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (errorElement) {
            errorElement.classList.add('hidden');
        }
    };
    // ==================== MODAL FUNCTIONS ====================
    const openForgotPasswordModal = () => {
        forgotPasswordModal.classList.remove('hidden');
        resetEmail.value = loginEmail.value || '';
    };
    const closeForgotPasswordModal = () => {
        forgotPasswordModal.classList.add('hidden');
        resetMessage.classList.add('hidden');
        hideFieldError('reset-email');
        resetEmail.value = '';
    };
    const sendPasswordReset = async () => {
        const email = resetEmail.value.trim();
        // Validasi email
        if (!email) {
            showFieldError('reset-email', 'Email tidak boleh kosong');
            return;
        }
        if (!validateEmail(email)) {
            showFieldError('reset-email', 'Format email tidak valid');
            return;
        }
        try {
            // Kirim email reset password
            await sendPasswordResetEmail(auth, email);
            // Tampilkan pesan sukses
            resetMessage.textContent = `Email reset password telah dikirim ke ${email}. Cek inbox Anda!`;
            resetMessage.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-800 border border-green-200';
            resetMessage.classList.remove('hidden');
            // Auto close modal setelah 3 detik
            setTimeout(() => {
                closeForgotPasswordModal();
                showNotification('Email reset password telah dikirim!', 'success');
            }, 3000);
        } catch (error) {
            console.error('Reset password error:', error);
            let message = 'Gagal mengirim email reset password';
            if (error.code === 'auth/user-not-found') {
                message = 'Email tidak terdaftar';
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Terlalu banyak percobaan. Coba lagi nanti';
            }
            showFieldError('reset-email', message);
        }
    };
    // ==================== EVENT LISTENERS ====================
    // Tab switching
    tabLogin.addEventListener('click', () => {
        tabLogin.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
        tabLogin.classList.remove('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
        tabRegister.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
        tabRegister.classList.add('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        authMessage.classList.add('hidden');
    });
    tabRegister.addEventListener('click', () => {
        tabRegister.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
        tabRegister.classList.remove('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
        tabLogin.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
        tabLogin.classList.add('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        authMessage.classList.add('hidden');
    });
    // Toggle password visibility
    toggleLoginPassword.addEventListener('click', () => {
        const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        loginPassword.setAttribute('type', type);
        toggleLoginPassword.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
    toggleRegisterPassword.addEventListener('click', () => {
        const type = registerPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        registerPassword.setAttribute('type', type);
        toggleRegisterPassword.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
    // Password strength indicator
    registerPassword.addEventListener('input', (e) => {
        updatePasswordStrength(e.target.value);
    });
    // Real-time username validation - dihapus karena tidak diperlukan sebelum register
    
    // Confirm password validation
    registerConfirm.addEventListener('input', () => {
        const password = registerPassword.value;
        const confirm = registerConfirm.value;
        if (!confirm) {
            hideFieldError('register-confirm');
            return;
        }
        if (password !== confirm) {
            showFieldError('register-confirm', 'Password tidak cocok');
        } else {
            hideFieldError('register-confirm');
        }
    });
    // Modal event listeners
    forgotPasswordBtn.addEventListener('click', openForgotPasswordModal);
    closeForgotModal.addEventListener('click', closeForgotPasswordModal);
    cancelReset.addEventListener('click', closeForgotPasswordModal);
    sendResetEmail.addEventListener('click', sendPasswordReset);
    // Enter key in reset email field
    resetEmail.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendPasswordReset();
        }
    });
    // ==================== FIREBASE INITIALIZATION ====================
    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log('Firebase initialized successfully');
            // Setup auth state listener
            setupAuthListener();
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showNotification('Gagal menginisialisasi database', 'error');
        }
    }
    // ==================== AUTH FUNCTIONS ====================
    function setupAuthListener() {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User logged in
                currentUser = user;
                userId = user.uid;
                // Update UI dengan info user
                updateUserUI(user);
                // Simpan user info ke Firestore jika baru register
                if (user.email && !user.isAnonymous) {
                    await saveUserInfo(user);
                }
                // Switch to main app
                authPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                // Load transactions
                listenForTransactions();
            } else {
                // User logged out
                currentUser = null;
                userId = null;
                // Switch to auth page
                authPage.classList.remove('hidden');
                mainApp.classList.add('hidden');
                // Reset form values
                loginForm.reset();
                registerForm.reset();
                authMessage.classList.add('hidden');
                // Reset password strength indicator
                updatePasswordStrength('');
            }
        });
    }
    async function saveUserInfo(user) {
        try {
            const userRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                // Simpan info user baru
                await setDoc(userRef, {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || 'Pengguna',
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    accountType: 'registered'
                });
                // Update cache
                if (user.email) emailCache.add(user.email);
                if (user.displayName) usernameCache.add(user.displayName);
            } else {
                // Update last login
                await setDoc(userRef, {
                    lastLogin: serverTimestamp()
                }, { merge: true });
            }
        } catch (error) {
            console.error('Error saving user info:', error);
        }
    }
    function updateUserUI(user) {
        if (user.email) {
            // Registered user
            userNameEl.textContent = user.displayName || user.email.split('@')[0];
            userEmailEl.textContent = user.email;
            guestBadge.classList.add('hidden');
        } else {
            // Guest user
            userNameEl.textContent = 'Tamu';
            userEmailEl.textContent = 'Mode Tamu';
            guestBadge.classList.remove('hidden');
        }
    }
    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        const rememberMe = rememberMeCheckbox.checked;
        // Validasi input
        if (!email || !password) {
            showAuthMessage('Harap isi email dan password', 'error');
            return;
        }
        if (!validateEmail(email)) {
            showFieldError('login-email', 'Format email tidak valid');
            return;
        }
        hideFieldError('login-email');
        hideFieldError('login-password');
        authMessage.classList.add('hidden');
        
        try {
            // Set persistence based on "Remember Me"
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            // Login dengan Firebase Auth
            await signInWithEmailAndPassword(auth, email, password);
            // Simpan ke localStorage jika "Remember Me" dicentang
            if (rememberMe) {
                localStorage.setItem('rememberedEmail', email);
                localStorage.setItem('rememberMe', 'true');
            } else {
                localStorage.removeItem('rememberedEmail');
                localStorage.removeItem('rememberMe');
            }
        } catch (error) {
            console.error('Login error:', error);
            let message = 'Login gagal';
            if (error.code === 'auth/invalid-credential') {
                message = 'Email atau password salah';
                showFieldError('login-password', 'Password salah');
            } else if (error.code === 'auth/user-not-found') {
                message = 'Akun tidak ditemukan';
                showFieldError('login-email', 'Email tidak terdaftar');
            } else if (error.code === 'auth/wrong-password') {
                message = 'Password salah';
                showFieldError('login-password', 'Password salah');
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Terlalu banyak percobaan. Coba lagi nanti';
            } else if (error.code === 'auth/network-request-failed') {
                message = 'Koneksi internet bermasalah';
            }
            showAuthMessage(message, 'error');
        }
    });
    // Register form submit - DIPERBAIKI
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        // Tampilkan loading state
        registerSubmitBtn.classList.add('loading-btn');
        registerSubmitBtn.disabled = true;
        
        const name = registerName.value.trim();
        const email = registerEmail.value.trim();
        const password = registerPassword.value;
        const confirmPassword = registerConfirm.value;
        const rememberMe = rememberMeCheckbox.checked;
        
        // Reset error messages sebelumnya
        hideFieldError('register-name');
        hideFieldError('register-email');
        hideFieldError('register-password');
        hideFieldError('register-confirm');
        authMessage.classList.add('hidden');
        
        // Validasi
        let hasError = false;
        // Validasi nama
        if (!name) {
            showFieldError('register-name', 'Nama tidak boleh kosong');
            hasError = true;
        } else if (name.length < 3) {
            showFieldError('register-name', 'Nama minimal 3 karakter');
            hasError = true;
        }
        // Validasi email
        if (!email) {
            showFieldError('register-email', 'Email tidak boleh kosong');
            hasError = true;
        } else if (!validateEmail(email)) {
            showFieldError('register-email', 'Format email tidak valid');
            hasError = true;
        }
        // Validasi password
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
            showFieldError('register-password', passwordValidation.message);
            hasError = true;
        }
        // Validasi konfirmasi password
        if (!confirmPassword) {
            showFieldError('register-confirm', 'Konfirmasi password tidak boleh kosong');
            hasError = true;
        } else if (password !== confirmPassword) {
            showFieldError('register-confirm', 'Password tidak cocok');
            hasError = true;
        }
        
        if (hasError) {
            registerSubmitBtn.classList.remove('loading-btn');
            registerSubmitBtn.disabled = false;
            return;
        }
        
        try {
            // Buat user baru di Firebase Auth - ini adalah langkah utama
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Update display name di Firebase Auth
            if (name) {
                await updateProfile(userCredential.user, {
                    displayName: name
                });
            }
            
            // Simpan info user ke Firestore
            await saveUserInfo(userCredential.user);
            
            // Set persistence based on "Remember Me"
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            
            // Simpan ke localStorage jika "Remember Me" dicentang
            if (rememberMe) {
                localStorage.setItem('rememberedEmail', email);
                localStorage.setItem('rememberMe', 'true');
            }
            
            // Tampilkan pesan sukses
            showAuthMessage('Akun berhasil dibuat! Mengarahkan...', 'success');
            
            // Update cache
            emailCache.add(email);
            usernameCache.add(name);
            
        } catch (error) {
            console.error('Register error:', error);
            let message = 'Pendaftaran gagal';
            
            // Handle Firebase Auth errors spesifik
            if (error.code === 'auth/email-already-in-use') {
                message = 'Email sudah terdaftar';
                showFieldError('register-email', 'Email sudah terdaftar');
                emailCache.add(email);
            } else if (error.code === 'auth/invalid-email') {
                message = 'Format email tidak valid';
                showFieldError('register-email', 'Format email tidak valid');
            } else if (error.code === 'auth/weak-password') {
                message = 'Password terlalu lemah (minimal 6 karakter)';
                showFieldError('register-password', message);
            } else if (error.code === 'auth/network-request-failed') {
                message = 'Koneksi internet bermasalah. Coba lagi nanti.';
            } else if (error.code === 'auth/operation-not-allowed') {
                message = 'Pendaftaran dengan email/password tidak diizinkan di Firebase console';
            } else {
                // Error umum
                message = 'Gagal membuat akun. Coba lagi nanti.';
            }
            
            showAuthMessage(message, 'error');
        } finally {
            // Selalu reset tombol submit setelah proses selesai
            registerSubmitBtn.classList.remove('loading-btn');
            registerSubmitBtn.disabled = false;
        }
    });
    // Guest login
    guestLoginBtn.addEventListener('click', async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error('Guest login error:', error);
            showAuthMessage('Gagal masuk sebagai tamu', 'error');
        }
    });
    // Logout
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error('Logout error:', error);
            showNotification('Gagal logout', 'error');
        }
    });
    // Backup data (placeholder)
    backupBtn.addEventListener('click', () => {
        showNotification('Fitur backup akan segera hadir!', 'info');
    });
    // ==================== TRANSACTION FUNCTIONS ====================
    function listenForTransactions() {
        if (!db || !userId) return;
        let collectionPath;
        if (currentUser && !currentUser.isAnonymous) {
            // Registered user: users/{userId}/transactions
            collectionPath = `users/${userId}/transactions`;
        } else {
            // Guest user: guests/{userId}/transactions
            collectionPath = `guests/${userId}/transactions`;
        }
        const transactionsRef = collection(db, collectionPath);
        const q = query(transactionsRef, orderBy('date', 'desc'));
        loadingTransactionsEl.classList.remove('hidden');
        noDataMessageEl.classList.add('hidden');
        onSnapshot(q, (snapshot) => {
            allTransactions = [];
            let totalIncome = 0;
            let totalExpense = 0;
            let incomeCount = 0;
            let expenseCount = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                const transaction = { 
                    id: doc.id, 
                    ...data,
                    // Convert Firestore timestamp to Date if needed
                    date: data.date || '',
                    amount: Number(data.amount) || 0
                };
                allTransactions.push(transaction);
                if (data.type === 'pemasukan') {
                    totalIncome += transaction.amount;
                    incomeCount++;
                } else if (data.type === 'pengeluaran') {
                    totalExpense += transaction.amount;
                    expenseCount++;
                }
            });
            // Update waktu terakhir
            lastUpdateEl.textContent = new Date().toLocaleTimeString('id-ID');
            // Update dashboard
            updateDashboard(totalIncome, totalExpense, incomeCount, expenseCount);
            // Apply filters dan render
            filterTransactions();
            // Hide loading
            loadingTransactionsEl.classList.add('hidden');
        }, (error) => {
            console.error("Error listening to transactions:", error);
            loadingTransactionsEl.classList.add('hidden');
            if (error.code === "permission-denied") {
                showNotification('Akses ditolak. Periksa Firestore Rules', 'error');
            } else {
                showNotification('Gagal memuat transaksi', 'error');
            }
        });
    }
    function updateDashboard(income, expense, incomeCount, expenseCount) {
        const balance = income - expense;
        totalIncomeEl.textContent = formatRupiah(income);
        totalExpenseEl.textContent = formatRupiah(expense);
        currentBalanceEl.textContent = formatRupiah(balance);
        incomeCountEl.textContent = `${incomeCount} transaksi`;
        expenseCountEl.textContent = `${expenseCount} transaksi`;
        totalTransactionsEl.textContent = allTransactions.length;
        totalTransactionCountEl.textContent = allTransactions.length;
        // Update warna saldo
        currentBalanceEl.classList.remove('balance-positive', 'balance-negative');
        if (balance >= 0) {
            currentBalanceEl.classList.add('balance-positive');
        } else {
            currentBalanceEl.classList.add('balance-negative');
        }
    }
    // ==================== FILTER FUNCTIONS ====================
    function filterTransactions() {
        filteredTransactions = allTransactions.filter(transaction => {
            // Filter berdasarkan bulan
            if (currentFilter.month) {
                const transactionMonth = transaction.date ? transaction.date.substring(0, 7) : '';
                if (transactionMonth !== currentFilter.month) {
                    return false;
                }
            }
            // Filter berdasarkan tipe
            if (currentFilter.type !== 'all' && transaction.type !== currentFilter.type) {
                return false;
            }
            // Filter berdasarkan kategori
            if (currentFilter.category !== 'all' && transaction.category !== currentFilter.category) {
                return false;
            }
            return true;
        });
        // Update UI
        updateFilterIndicator();
        renderTransactions();
        updatePagination();
        // Update statistik bulanan jika ada filter bulan
        if (currentFilter.month) {
            updateMonthlyStats();
            monthlyStatsEl.classList.remove('hidden');
        } else {
            monthlyStatsEl.classList.add('hidden');
        }
    }
    function updateFilterIndicator() {
        let indicatorText = '';
        if (currentFilter.month) {
            indicatorText = getMonthName(currentFilter.month);
        }
        if (currentFilter.type !== 'all') {
            if (indicatorText) indicatorText += ' • ';
            indicatorText += currentFilter.type === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran';
        }
        if (currentFilter.category !== 'all') {
            if (indicatorText) indicatorText += ' • ';
            indicatorText += currentFilter.category;
        }
        if (indicatorText) {
            filterIndicatorEl.textContent = indicatorText;
            filterIndicatorEl.classList.remove('hidden');
            // Show filtered count
            filteredCountEl.textContent = `${filteredTransactions.length} dari ${allTransactions.length}`;
            filteredCountEl.classList.remove('hidden');
        } else {
            filterIndicatorEl.classList.add('hidden');
            filteredCountEl.classList.add('hidden');
        }
        transactionCountEl.textContent = filteredTransactions.length > 0 ? filteredTransactions.length : '0';
    }
    function updateMonthlyStats() {
        const monthTransactions = allTransactions.filter(t => {
            const transactionMonth = t.date ? t.date.substring(0, 7) : '';
            return transactionMonth === currentFilter.month;
        });
        if (monthTransactions.length === 0) {
            monthTransactionCountEl.textContent = '0';
            monthDailyAvgEl.textContent = 'Rp 0';
            monthLargestEl.textContent = 'Rp 0';
            monthBalanceEl.textContent = 'Rp 0';
            return;
        }
        const monthIncome = monthTransactions
            .filter(t => t.type === 'pemasukan')
            .reduce((sum, t) => sum + Number(t.amount), 0);
        const monthExpense = monthTransactions
            .filter(t => t.type === 'pengeluaran')
            .reduce((sum, t) => sum + Number(t.amount), 0);
        const monthBalance = monthIncome - monthExpense;
        // Hitung rata-rata harian (diasumsikan 30 hari)
        const dailyAvg = Math.round(monthExpense / 30);
        // Temukan transaksi terbesar
        const largestTransaction = monthTransactions.reduce((max, t) => 
            Number(t.amount) > Number(max.amount) ? t : max, monthTransactions[0]
        );
        monthTransactionCountEl.textContent = monthTransactions.length;
        monthDailyAvgEl.textContent = formatRupiah(dailyAvg);
        monthLargestEl.textContent = formatRupiah(largestTransaction.amount);
        monthBalanceEl.textContent = formatRupiah(monthBalance);
        // Update warna saldo bulanan
        monthBalanceEl.classList.remove('balance-positive', 'balance-negative');
        if (monthBalance >= 0) {
            monthBalanceEl.classList.add('balance-positive');
        } else {
            monthBalanceEl.classList.add('balance-negative');
        }
    }
    // ==================== RENDER TRANSACTIONS ====================
    function renderTransactions() {
        transactionsListEl.innerHTML = '';
        if (filteredTransactions.length === 0) {
            noDataMessageEl.classList.remove('hidden');
            transactionCountEl.textContent = '0';
            return;
        }
        noDataMessageEl.classList.add('hidden');
        // Hitung pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
        transactionCountEl.textContent = filteredTransactions.length;
        paginatedTransactions.forEach(t => {
            const isIncome = t.type === 'pemasukan';
            const color = isIncome ? 'border-green-400' : 'border-red-400';
            const bgColor = isIncome ? 'bg-green-50' : 'bg-red-50';
            const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';
            const sign = isIncome ? '+' : '-';
            const amountValue = Number(t.amount) || 0;
            const item = document.createElement('div');
            item.className = `p-4 border-l-4 ${color} ${bgColor} rounded-xl shadow-sm flex justify-between items-center transition-all duration-300 hover:shadow-md hover:-translate-y-1`;
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full ${isIncome ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center mr-4">
                        <i class="fas ${icon} ${isIncome ? 'text-green-600' : 'text-red-600'}"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">${t.description || 'Tanpa keterangan'}</p>
                        <div class="flex items-center mt-1">
                            <span class="text-xs px-2 py-1 rounded-full ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mr-2">
                                ${t.category || 'lainnya'}
                            </span>
                            <span class="text-xs text-gray-500">
                                <i class="far fa-calendar mr-1"></i>${t.date ? new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Tanggal tidak valid'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">${sign} ${formatRupiah(amountValue)}</p>
                    <div class="mt-2">
                        <button data-id="${t.id}" class="delete-btn text-xs text-red-500 hover:text-red-700 mr-3">
                            <i class="fas fa-trash-alt mr-1"></i>Hapus
                        </button>
                    </div>
                </div>
            `;
            transactionsListEl.appendChild(item);
        });
        // Attach delete listeners
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteTransaction);
        });
    }
    function updatePagination() {
        const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
        if (totalPages > 1) {
            paginationEl.classList.remove('hidden');
            pageInfoEl.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            // Enable/disable buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            prevPageBtn.classList.toggle('opacity-50', currentPage === 1);
            nextPageBtn.classList.toggle('opacity-50', currentPage === totalPages);
        } else {
            paginationEl.classList.add('hidden');
        }
    }
    // ==================== TRANSACTION EVENT HANDLERS ====================
    // Tipe transaksi
    typePemasukanBtn.addEventListener('click', () => handleTransactionTypeChange('pemasukan'));
    typePengeluaranBtn.addEventListener('click', () => handleTransactionTypeChange('pengeluaran'));
    function handleTransactionTypeChange(newType) {
        transactionTypeInput.value = newType;
        if (newType === 'pemasukan') {
            typePemasukanBtn.classList.remove('bg-gradient-to-r', 'from-gray-200', 'to-gray-300', 'text-gray-800');
            typePemasukanBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'text-white');
            typePengeluaranBtn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'text-white');
            typePengeluaranBtn.classList.add('bg-gradient-to-r', 'from-gray-200', 'to-gray-300', 'text-gray-800');
        } else {
            typePengeluaranBtn.classList.remove('bg-gradient-to-r', 'from-gray-200', 'to-gray-300', 'text-gray-800');
            typePengeluaranBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'text-white');
            typePemasukanBtn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'text-white');
            typePemasukanBtn.classList.add('bg-gradient-to-r', 'from-gray-200', 'to-gray-300', 'text-gray-800');
        }
    }
    // Filter events
    monthFilterEl.addEventListener('change', (e) => {
        currentFilter.month = e.target.value || null;
        currentPage = 1;
        filterTransactions();
    });
    typeFilterEl.addEventListener('change', (e) => {
        currentFilter.type = e.target.value;
        currentPage = 1;
        filterTransactions();
    });
    categoryFilterEl.addEventListener('change', (e) => {
        currentFilter.category = e.target.value;
        currentPage = 1;
        filterTransactions();
    });
    resetFilterBtn.addEventListener('click', () => {
        monthFilterEl.value = currentMonth;
        typeFilterEl.value = 'all';
        categoryFilterEl.value = 'all';
        currentFilter.month = null;
        currentFilter.type = 'all';
        currentFilter.category = 'all';
        currentPage = 1;
        filterTransactions();
    });
    // Pagination
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTransactions();
            updatePagination();
        }
    });
    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTransactions();
            updatePagination();
        }
    });
    // Add transaction
    transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userId) {
            showNotification('Silakan login terlebih dahulu', 'error');
            return;
        }
        const amount = amountInput.value;
        const description = descriptionInput.value.trim();
        const date = dateInput.value; 
        const type = transactionTypeInput.value;
        const category = categoryInput.value;
        if (!amount || !description || !date) {
            showNotification('Harap lengkapi semua data!', 'error');
            return;
        }
        if (amount <= 0) {
            showNotification('Jumlah harus lebih dari 0', 'error');
            return;
        }
        try {
            let collectionPath;
            if (currentUser && !currentUser.isAnonymous) {
                collectionPath = `users/${userId}/transactions`;
            } else {
                collectionPath = `guests/${userId}/transactions`;
            }
            const transactionsRef = collection(db, collectionPath);
            await addDoc(transactionsRef, {
                amount: Number(amount),
                description: description,
                date: date,
                type: type,
                category: category,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            // Reset form setelah berhasil
            transactionForm.reset();
            dateInput.value = formattedDate;
            categoryInput.value = 'lainnya';
            handleTransactionTypeChange('pemasukan');
            showNotification('Transaksi berhasil dicatat!', 'success');
        } catch (error) {
            console.error("Gagal menambahkan transaksi:", error);
            showNotification(`Gagal menyimpan transaksi: ${error.message}`, 'error');
        }
    });
    // Delete transaction
    async function handleDeleteTransaction(e) {
        const transactionId = e.target.closest('button').dataset.id;
        if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
            return;
        }
        try {
            let collectionPath;
            if (currentUser && !currentUser.isAnonymous) {
                collectionPath = `users/${userId}/transactions/${transactionId}`;
            } else {
                collectionPath = `guests/${userId}/transactions/${transactionId}`;
            }
            const transactionDocRef = doc(db, collectionPath);
            await deleteDoc(transactionDocRef);
            showNotification('Transaksi berhasil dihapus!', 'success');
        } catch (error) {
            console.error("Gagal menghapus transaksi:", error);
            showNotification('Gagal menghapus transaksi', 'error');
        }
    }
    // ==================== START APPLICATION ====================
    // Inisialisasi Firebase
    initializeFirebase();
</script>
</body>
</html>

