<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Keuangan Pribadi</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .balance-positive { color: #10B981; }
        .balance-negative { color: #EF4444; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8">
    <div class="max-w-xl mx-auto">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Catatan Keuangan Pribadi</h1>

        <!-- Status & Notifikasi -->
        <div id="status-card" class="bg-indigo-50 border border-indigo-200 text-indigo-800 p-4 rounded-xl shadow-md mb-6">
            <p id="auth-status" class="font-semibold text-center text-sm">Memuat status otentikasi...</p>
            <p id="user-id-display" class="text-xs text-center mt-1"></p>
        </div>

        <!-- Dashboard Saldo -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <p class="text-sm font-medium text-gray-500 mb-2">Saldo Saat Ini</p>
            <div id="current-balance" class="text-4xl font-bold text-blue-700">Rp 0</div>
            
            <div class="flex justify-between mt-4 space-x-4">
                <div class="flex-1 p-3 bg-green-50 rounded-lg text-center">
                    <p class="text-xs font-medium text-gray-600">Masuk</p>
                    <p id="total-income" class="text-xl font-bold text-green-600">Rp 0</p>
                </div>
                <div class="flex-1 p-3 bg-red-50 rounded-lg text-center">
                    <p class="text-xs font-medium text-gray-600">Keluar</p>
                    <p id="total-expense" class="text-xl font-bold text-red-600">Rp 0</p>
                </div>
            </div>
        </div>

        <!-- Form Transaksi Baru -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">Tambah Transaksi Baru</h2>
            <form id="transaction-form" class="space-y-4">
                
                <div class="flex space-x-2">
                    <button type="button" id="type-pemasukan" class="flex-1 p-3 rounded-lg font-bold bg-green-500 text-white shadow-md transition duration-150 active:scale-95">Pemasukan (+)</button>
                    <button type="button" id="type-pengeluaran" class="flex-1 p-3 rounded-lg font-bold bg-gray-200 text-gray-700 shadow-md transition duration-150 active:scale-95">Pengeluaran (-)</button>
                    <input type="hidden" id="transaction-type" value="pemasukan">
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                    <input type="number" id="amount" placeholder="Contoh: 50000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Keterangan</label>
                    <input type="text" id="description" placeholder="Contoh: Gaji bulanan, Beli kopi" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>

                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">Tanggal</label>
                    <input type="date" id="date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 active:scale-95">Catat Transaksi</button>
            </form>
        </div>

        <!-- Daftar Transaksi -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Riwayat Transaksi</h2>
            <div id="transactions-list" class="space-y-3">
                <!-- Data transaksi akan dimuat di sini -->
                <p id="loading-message" class="text-center text-gray-500">Memuat data dari Cloud Firestore...</p>
            </div>
            <p id="no-data-message" class="text-center text-gray-500 hidden mt-4">Belum ada transaksi. Silakan tambahkan satu!</p>
        </div>
        
    </div>
</div>

<!-- Firebase SDK Imports (Module) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, onSnapshot, query, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 1. HARDCODED FIREBASE CONFIGURATION (Fixes Vercel Env Issue) ---
    // Konfigurasi ini diambil langsung dari detail proyek Firebase Anda.
    const firebaseConfig = {
        apiKey: "AIzaSyBWGcB71XutjePkzHM6NUMhuIeoUhk4S8I",
        authDomain: "keuangan-vercel.firebaseapp.com",
        projectId: "keuangan-vercel",
        storageBucket: "keuangan-vercel.firebasestorage.app",
        messagingSenderId: "314524581902",
        appId: "1:314524581902:web:2fec2d7c086cb739db3c5f",
        measurementId: "G-YH4KXP51KL" // Opsional
    };

    // --- 2. ENVIRONMENT VARIABLES (Keep for Canvas Compatibility) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // Gunakan variabel ini karena Vercel/GitHub menyediakan token otentikasi kustom
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    
    // Elemen UI
    const authStatusEl = document.getElementById('auth-status');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const loadingMessageEl = document.getElementById('loading-message');
    const noDataMessageEl = document.getElementById('no-data-message');
    const totalIncomeEl = document.getElementById('total-income');
    const totalExpenseEl = document.getElementById('total-expense');
    const currentBalanceEl = document.getElementById('current-balance');
    const transactionsListEl = document.getElementById('transactions-list');
    const transactionForm = document.getElementById('transaction-form');
    const typePemasukanBtn = document.getElementById('type-pemasukan');
    const typePengeluaranBtn = document.getElementById('type-pengeluaran');
    const transactionTypeInput = document.getElementById('transaction-type');
    
    // Set tanggal hari ini secara default
    document.getElementById('date').valueAsDate = new Date();
    
    // --- Helper Functions ---
    const formatRupiah = (number) => {
        return 'Rp ' + number.toLocaleString('id-ID');
    };

    const getCollectionPath = (uid) => {
        // Menggunakan jalur data PRIVATE yang aman dan sesuai dengan Aturan Keamanan.
        return `artifacts/${appId}/users/${uid}/transactions`;
    };

    const handleTransactionTypeChange = (newType) => {
        transactionTypeInput.value = newType;
        if (newType === 'pemasukan') {
            typePemasukanBtn.classList.remove('bg-gray-200', 'text-gray-700');
            typePemasukanBtn.classList.add('bg-green-500', 'text-white');
            typePengeluaranBtn.classList.remove('bg-red-500', 'text-white');
            typePengeluaranBtn.classList.add('bg-gray-200', 'text-gray-700');
        } else {
            typePengeluaranBtn.classList.remove('bg-gray-200', 'text-gray-700');
            typePengeluaranBtn.classList.add('bg-red-500', 'text-white');
            typePemasukanBtn.classList.remove('bg-green-500', 'text-white');
            typePemasukanBtn.classList.add('bg-gray-200', 'text-gray-700');
        }
    };

    // --- Firebase Initialization and Auth ---
    async function initializeFirebase() {
        if (!firebaseConfig.apiKey) {
            authStatusEl.textContent = "Error: Konfigurasi Firebase Hilang/Gagal Diinisialisasi!";
            authStatusEl.classList.remove('text-indigo-800');
            authStatusEl.classList.add('text-red-800');
            return;
        }

        try {
            setLogLevel('debug'); // Untuk debugging di konsol
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Tanda tangani pengguna menggunakan token kustom atau anonim
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 2. Dengarkan perubahan status otentikasi
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authStatusEl.textContent = "Database AKTIF & AMAN.";
                    userIdDisplayEl.textContent = `ID Pengguna: ${userId} | Jalur Data: artifacts/${appId}/users/${userId}/...`;
                    authStatusEl.classList.remove('text-red-800', 'text-indigo-800');
                    authStatusEl.classList.add('text-green-800');
                    
                    // Setelah otentikasi berhasil, mulai mendengarkan data Firestore
                    listenForTransactions();
                } else {
                    userId = null;
                    authStatusEl.textContent = "Error: Otentikasi Gagal. Tidak ada pengguna yang masuk.";
                    userIdDisplayEl.textContent = 'Silakan periksa Aturan Keamanan Firebase Anda.';
                    authStatusEl.classList.remove('text-green-800', 'text-indigo-800');
                    authStatusEl.classList.add('text-red-800');
                }
            });

        } catch (error) {
            console.error("Gagal menginisialisasi Firebase atau Otentikasi:", error);
            authStatusEl.textContent = `Error Otentikasi: ${error.code}. Periksa Konsol & Konfigurasi Firebase.`;
            authStatusEl.classList.remove('text-indigo-800');
            authStatusEl.classList.add('text-red-800');
        }
    }

    // --- Firestore Data Listener ---
    function listenForTransactions() {
        if (!db || !userId) return; 

        const transactionsRef = collection(db, getCollectionPath(userId));
        const q = query(transactionsRef);

        // onSnapshot menyediakan pembaruan real-time
        onSnapshot(q, (snapshot) => {
            const transactions = [];
            let totalIncome = 0;
            let totalExpense = 0;

            snapshot.forEach((doc) => {
                const data = doc.data();
                transactions.push({ id: doc.id, ...data });

                const amount = parseInt(data.amount);
                if (data.type === 'pemasukan') {
                    totalIncome += amount;
                } else if (data.type === 'pengeluaran') {
                    totalExpense += amount;
                }
            });

            // Sortir transaksi berdasarkan tanggal (terbaru dulu)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Perbarui UI
            updateDashboard(totalIncome, totalExpense);
            renderTransactions(transactions);

        }, (error) => {
            console.error("Gagal mendengarkan transaksi:", error);
            // Hanya tampilkan pesan error jika ini BUKAN error konfigurasi
            if (error.code !== "permission-denied") {
                authStatusEl.textContent = "Error: Gagal Memuat Data. Cek Aturan Keamanan Firestore.";
                authStatusEl.classList.remove('text-indigo-800', 'text-green-800');
                authStatusEl.classList.add('text-red-800');
            }
        });
    }

    // --- UI Update Functions ---
    function updateDashboard(income, expense) {
        const balance = income - expense;
        totalIncomeEl.textContent = formatRupiah(income);
        totalExpenseEl.textContent = formatRupiah(expense);
        currentBalanceEl.textContent = formatRupiah(balance);

        currentBalanceEl.classList.remove('text-blue-700', 'text-red-700');
        if (balance >= 0) {
            currentBalanceEl.classList.add('text-blue-700');
        } else {
            currentBalanceEl.classList.add('text-red-700');
        }
    }

    function renderTransactions(transactions) {
        transactionsListEl.innerHTML = '';
        loadingMessageEl.classList.add('hidden');

        if (transactions.length === 0) {
            noDataMessageEl.classList.remove('hidden');
            return;
        }

        noDataMessageEl.classList.add('hidden');

        transactions.forEach(t => {
            const isIncome = t.type === 'pemasukan';
            const color = isIncome ? 'border-green-400' : 'border-red-400';
            const sign = isIncome ? '+' : '-';

            const item = document.createElement('div');
            item.className = `p-3 border-l-4 ${color} bg-gray-50 rounded-lg shadow-sm flex justify-between items-center transition duration-150 hover:bg-gray-100`;
            item.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${t.description}</p>
                    <p class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'}">${sign} ${formatRupiah(parseInt(t.amount))}</p>
                    <button data-id="${t.id}" class="delete-btn text-xs text-red-500 hover:text-red-700 mt-1">Hapus</button>
                </div>
            `;
            transactionsListEl.appendChild(item);
        });

        // Attach delete listeners
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteTransaction);
        });
    }

    // --- Event Handlers ---
    typePemasukanBtn.addEventListener('click', () => handleTransactionTypeChange('pemasukan'));
    typePengeluaranBtn.addEventListener('click', () => handleTransactionTypeChange('pengeluaran'));

    transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!userId) {
            console.error('Aplikasi belum terotentikasi. Tidak dapat menyimpan data.');
            return;
        }

        const amount = document.getElementById('amount').value;
        const description = document.getElementById('description').value;
        const date = document.getElementById('date').value; 
        const type = transactionTypeInput.value;

        if (!amount || !description || !date) return;

        try {
            const transactionsRef = collection(db, getCollectionPath(userId));
            await addDoc(transactionsRef, {
                amount: amount,
                description: description,
                date: date,
                type: type,
                createdAt: new Date().toISOString()
            });

            // Reset form setelah berhasil
            transactionForm.reset();
            document.getElementById('date').valueAsDate = new Date(); // Reset tanggal
            handleTransactionTypeChange('pemasukan'); // Reset tipe
            
        } catch (error) {
            console.error("Gagal menambahkan transaksi:", error);
            // Gunakan console.error alih-alih alert
        }
    });

    async function handleDeleteTransaction(e) {
        const transactionId = e.target.dataset.id;
        
        if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
            return;
        }
        
        try {
            const transactionDocRef = doc(db, getCollectionPath(userId), transactionId);
            await deleteDoc(transactionDocRef);
        } catch (error) {
            console.error("Gagal menghapus transaksi:", error);
        }
    }


    // --- Start Application ---
    initializeFirebase();

</script>
</body>
</html>

